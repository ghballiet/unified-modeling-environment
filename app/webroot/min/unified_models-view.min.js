$(document).ready(function(){function grabExogenousData(){var url=$("#data-url").val();$.post(url,{},function(data){eval(data);console.log("Values: ",values);console.log("Facts: ",empirical_data);console.log("Simulation data loaded.");drawCharts(values)})}function createRows(a,b){var c=b.entity_name;for(var d in b){if(d=="id"||d=="entity_name")continue;var e=$("<tr />"),f=$("<span />").addClass("name").html(d),g=$("<td />").addClass("row").html(a),h=$("<td />").addClass("name").append(f),i=$("<td />").addClass("value").html(b[d]);e.append(g).append(h).append(i);$("#simulation-data tbody").append(e)}}function drawCharts(a){var b={};for(var c in a[0]){var d=new google.visualization.DataTable;d.addColumn("number","Time");d.addColumn("number","Simulated");d.addColumn("number","Observed");b[c]=d}for(var c in a)for(var e in a[c]){var f=[];f.push(parseInt(c));var g=a[c][e];if($.inArray(e,lhs_variables)==-1){f.push(empirical_data[c][e]);f.push(parseFloat(g.toFixed(2)))}else{f.push(parseFloat(g.toFixed(2)));f.push(empirical_data[c][e])}b[e].addRows([f])}var h=$("#right").width();for(var c in b){var i={width:h,height:100,title:c,fontSize:10,fontName:"Helvetica, Arial",legend:{position:"bottom"}},j=c.toLowerCase().replace(/\./g,"-").replace(/_/g,"-"),k=$("<div />").attr("id","chart-"+j).addClass("google-chart");$("#google-chart").append(k);var l=new google.visualization.LineChart(document.getElementById("chart-"+j));l.draw(b[c],i);var m=$("<input >").attr({type:"checkbox",name:c,id:"chk-"+j,checked:!0,"data-show-id":"chart-"+j}).addClass("chk-data-select"),n=$("<label />").attr("for","chk-"+j);n.html(c);var o=$("<div />").addClass("data-select").append(m).append(n);$("#data-selection").append(o)}$("input.chk-data-select").live("change",function(){var a=$(this).attr("data-show-id");$(this).is(":checked")?$("#"+a).show("fast"):$("#"+a).hide("fast")})}function genericProcessArgs(){$("#GenericProcessNumArguments").change(function(){var a=parseInt($(this).val())+1,b=0;$("div.input.hidden").hide();for(b=1;b<=a;b++)$("#arg_"+b).show()})}function concreteProcessArgs(){var a=$("#ConcreteProcessGenericProcessId").val();loadConcreteProcessArgs(a);$("#ConcreteProcessGenericProcessId").change(function(){loadConcreteProcessArgs($(this).val())})}function loadConcreteProcessArgs(a){var b=concrete_process_argument_list,c=0;$("#ConcreteProcessArguments").html("");for(var d in b[a]){c++;var e=b[a][d],f=$("<div />").addClass("input select"),g=parseInt(d)+1,h=$("<label />").html("Argument "+g),i=$("<select />").attr("name","data[ConcreteProcess][argument-"+d+"]");for(var j in e){var k=$("<option />").val(j).html(e[j]);i.append(k)}f.append(h).append(i);$("#ConcreteProcessArguments").append(f)}$("#ConcreteProcessNumArguments").val(c)}function setupEditEvents(){$("div.concrete-process-attribute").click(function(){$(this).editConcreteProcessAttribute()});$("div.concrete-attribute").click(function(){$(this).editConcreteAttribute()});$("div.concrete-equation").click(function(){$(this).editConcreteEquation()});$("div.generic-process-attribute").click(function(){$(this).editGenericProcessAttribute()});$("div.generic-equation").click(function(){$(this).editGenericEquation()});$("div.generic-attribute").click(function(){$(this).editGenericAttribute()});$("span.generic-condition").click(function(){$(this).editGenericCondition()})}function showModal(a){var b=$("<div />").addClass("reveal-modal").addClass(a.controller),c=$("<h1 />").html(a.title),d=$("<a />").html("&#215;").addClass("close-reveal-modal").attr("href","#"),e=$("<form />").attr({method:"post",action:"../../"+a.controller+"/edit/"+a.fields.id.value});b.append(d).append(c).append(e);$("#content").prepend(b);for(var f in a.fields){var g=a.fields[f],h=$("<div />").addClass("input").addClass(g.type),i=$("<label />").html(g.label),j=$("<input >").attr({type:g.type,name:"data["+a.type+"]["+f+"]"}).val(g.value);h.append(i).append(j);e.append(h)}var k=$("<div />").addClass("submit"),l=$("<input >").attr("type","submit").val("Save");k.html(l);e.append(k);b.reveal()}function displaySimulationData(a){for(var b in a.names){var c=a.names[b].toLowerCase();if(c=="time")continue;var d=new google.visualization.DataTable;d.addColumn("number","time");d.addColumn("number","Simulated");d.addColumn("number","Observed");for(var e in a.values){var f=parseFloat(a.values[e][b].replace(/d/g,"e+")),g=parseFloat(a.values[e][0].replace(/d/g,"e+")),h=parseFloat(exogenous_values.values[e][b]);f=parseFloat(f.toFixed(2));h=parseFloat(h.toFixed(2));d.addRow([g,f,h])}var i=$("#right").width(),j={width:i,height:150,title:c,fontSize:10,fontName:"Helvetica, Arial",legend:{position:"bottom"}},k=c.replace(/\./g,"-").replace(/_/g,"-"),l=$("<div />").attr("id","chart-"+k).addClass("google-chart");$("#google-chart").append(l);var m=new google.visualization.LineChart(document.getElementById("chart-"+k));m.draw(d,j)}}$("a.deleteModel").live("click",function(a){a.preventDefault();var b=$(this).attr("data-delete-url"),c=confirm("Are you sure you want to delete this model? This CANNOT be undone.");c&&(window.location=b)});$("a.expand").toggle(function(){var a=$("#"+$(this).attr("data-expand-id")),b=$("#"+a.attr("data-expand-id")),c=b.find("div.generic-attribute");a.html(c.clone());a.find("a.btnDelete").remove();a.fadeIn("fast");$(this).html("&#x25b2;")},function(){var a=$("#"+$(this).attr("data-expand-id"));a.hide();$(this).html("&#x25bc;")});$('input[type="text"], textarea').live("keypress",function(a){if($(this).attr("id")=="ConcreteEquationRightHandSide"||$(this).attr("id")=="GenericEquationRightHandSide"||$(this).attr("id")=="ExogenousValueValue"||$(this).attr("id")=="EmpiricalObservationValue"||$(this).attr("name")=="data[GenericEquation][right_hand_side]"||$(this).attr("name")=="data[ConcreteEquation][right_hand_side]"||$(this).attr("id")=="GenericConditionValue"||$(this).attr("name")=="data[GenericCondition][value]"||$(this).attr("name")=="data[ConcreteCondition][value]")return!0;if(a.keyCode==32){a.preventDefault();var b=$(this).val()+"_";$(this).val(b)}else{var c=String.fromCharCode(a.keyCode);c.match(/\W/g)!=null&&c!="."&&a.preventDefault()}});$.fn.editGenericCondition=function(){var a=$(this).attr("id"),b="generic-condition",c=parseInt(a.replace(b+"-","")),d=$(this).text(),e=parseInt(model.UnifiedModel.id),f={type:"GenericCondition",title:"Edit Generic Process Condition",controller:"generic_conditions",fields:{id:{label:"",type:"hidden",value:c},value:{label:"Value",type:"text",value:d},unified_model_id:{label:"",type:"hidden",value:e}}};showModal(f);var g=$("<a />").addClass("btnDelete").html("Delete Condition");g.attr("href","../../"+f.controller+"/delete/"+c+"/"+e);$("div.reveal-modal.generic_conditions").append(g)};$.fn.editConcreteProcessAttribute=function(){var a=$(this).attr("id"),b=$(this).attr("class"),c=parseInt(a.replace(b+"-","")),d=$(this).find("span.name").html(),e=$(this).find("span.value").html(),f=parseInt(model.UnifiedModel.id),g={type:"ConcreteProcessAttribute",title:"Edit Concrete Process Attribute",controller:"concrete_process_attributes",fields:{id:{label:"",type:"hidden",value:c},name:{label:"Name",type:"text",value:d},value:{label:"Value",type:"text",value:e},unified_model_id:{label:"",type:"hidden",value:f}}};showModal(g)};$.fn.editGenericAttribute=function(){var a=$(this).attr("id"),b=$(this).attr("class"),c=parseInt(a.replace(b+"-","")),d=$(this).find("span.name").html(),e=$(this).find("span.value").html(),f=parseInt(model.UnifiedModel.id),g={type:"GenericAttribute",title:"Edit Generic Attribute",controller:"generic_attributes",fields:{id:{label:"",type:"hidden",value:c},name:{label:"Name",type:"text",value:d},value:{label:"Value",type:"text",value:e},unified_model_id:{label:"",type:"hidden",value:f}}};showModal(g)};$.fn.editGenericEquation=function(){var a=$(this).attr("id"),b=$(this).attr("class"),c=parseInt(a.replace(b+"-","")),d=$(this).find("span.name").html(),e=$(this).find("span.value").html(),f=parseInt(model.UnifiedModel.id),g={type:"GenericEquation",title:"Edit Generic Equation",controller:"generic_equations",fields:{id:{label:"",type:"hidden",value:c},right_hand_side:{label:"Right Hand Side",type:"text",value:e},unified_model_id:{label:"",type:"hidden",value:f}}};showModal(g)};$.fn.editGenericProcessAttribute=function(){var a=$(this).attr("id"),b=$(this).attr("class"),c=parseInt(a.replace(b+"-","")),d=$(this).find("span.name").html(),e=$(this).find("span.value").html(),f=parseInt(model.UnifiedModel.id),g={type:"GenericProcessAttribute",title:"Edit Generic Process Attribute",controller:"generic_process_attributes",fields:{id:{label:"",type:"hidden",value:c},name:{label:"Name",type:"text",value:d},value:{label:"Value",type:"text",value:e},unified_model_id:{label:"",type:"hidden",value:f}}};showModal(g)};$.fn.editConcreteAttribute=function(){var a=$(this).attr("id"),b=$(this).attr("class"),c=parseInt(a.replace(b+"-","")),d=$(this).find("span.name").html(),e=$(this).find("span.value").html(),f=parseInt(model.UnifiedModel.id),g={type:"ConcreteAttribute",title:"Edit Concrete Attribute",controller:"concrete_attributes",fields:{id:{label:"",type:"hidden",value:c},name:{label:"Name",type:"text",value:d},value:{label:"Value",type:"text",value:e},unified_model_id:{label:"",type:"hidden",value:f}}};showModal(g)};$.fn.editConcreteEquation=function(){var a=$(this).attr("id"),b=$(this).attr("class"),c=parseInt(a.replace(b+"-","")),d=$(this).find("span.name")+"."+$(this).find("span.attr").html();console.log($(this));var e=$(this).find("span.value").html(),f=parseInt(model.UnifiedModel.id),g={type:"ConcreteEquation",title:"Edit Concrete Equation",controller:"concrete_equations",fields:{id:{label:"",type:"hidden",value:c},right_hand_side:{label:"Right Hand Side",type:"text",value:e},unified_model_id:{label:"",type:"hidden",value:f}}};showModal(g)};$("#btnSimulate").click(function(e){e.preventDefault();var id=model.UnifiedModel.id,url="../simulate_lisp/"+id;$("#simulating-msg").reveal({closeonbackgroundclick:!1});ex_values=exogenous_values.ExogenousValue.value;lines=ex_values.split("\n");var rows={};rows.values={};for(var i in lines){var line=lines[i];i==0?rows.names=line.trim().split(" "):rows.values[i-1]=line.trim().split(" ")}exogenous_values=rows;$.get(url,function(response){$("#simulating-msg").trigger("reveal:close");eval(response);console.log(data);displaySimulationData(data)})});genericProcessArgs();concreteProcessArgs();setupEditEvents()});